name: DG Monitor

on:
  schedule:
    - cron: "*/5 * * * *"  # æ¯5åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

jobs:
  check-dg:
    runs-on: ubuntu-latest

    steps:
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.x"

    - name: Install dependencies
      run: pip install requests selenium webdriver-manager

    - name: Run DG Monitoring Script
      run: |
        import os, time, requests
        from selenium import webdriver
        from selenium.webdriver.chrome.service import Service
        from selenium.webdriver.common.by import By
        from webdriver_manager.chrome import ChromeDriverManager

        TELEGRAM_TOKEN = "8134230045:AAH6C_H53R_J2RH98fGTqZFHsjkKALhsTh8"
        TELEGRAM_CHAT_ID = "485427847"
        DG_URLS = ["https://dg18.co/wap/", "https://dg18.co/"]

        def send_telegram_message(message):
            url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage"
            payload = {"chat_id": TELEGRAM_CHAT_ID, "text": message}
            requests.post(url, data=payload)

        def detect_dg():
            options = webdriver.ChromeOptions()
            options.add_argument("--headless=new")
            driver = webdriver.Chrome(service=Service(ChromeDriverManager().install()), options=options)

            try:
                driver.get(DG_URLS[0])
                time.sleep(5)

                # ç‚¹å‡»â€œå…è´¹è¯•ç©â€æˆ– Free
                try:
                    btn = driver.find_element(By.XPATH, "//button[contains(text(),'å…è´¹è¯•ç©') or contains(text(),'Free')]")
                    btn.click()
                    time.sleep(5)
                except:
                    pass

                # TODO: è¿™é‡Œéœ€è¦ä½ æŒ‰ä½ çš„çŠ¶å†µA / æ”¾æ°´é€»è¾‘è§£æå°æ¡Œèµ°åŠ¿
                # ä¸‹é¢åªæ˜¯ç¤ºä¾‹
                page_source = driver.page_source
                if "é•¿é¾™" in page_source or "å¤šè¿" in page_source:
                    send_telegram_message("ğŸ”¥ æ”¾æ°´æ—¶æ®µï¼ˆæé«˜èƒœç‡ï¼‰æ£€æµ‹åˆ°ï¼å¿«å…¥åœºï¼")
                elif "ä¸­ç­‰èƒœç‡" in page_source:
                    send_telegram_message("âš¡ ä¸­ç­‰èƒœç‡ï¼ˆä¸­ä¸Šï¼‰æ£€æµ‹åˆ°ï¼Œå¯ä»¥ç•™æ„å…¥åœºã€‚")
                else:
                    print("æ— å…¥åœºæœºä¼š")

            finally:
                driver.quit()

        detect_dg()
